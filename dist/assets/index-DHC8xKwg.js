var k=Object.defineProperty;var E=(g,t,i)=>t in g?k(g,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):g[t]=i;var z=(g,t,i)=>E(g,typeof t!="symbol"?t+"":t,i);import{t as I,f as B}from"./aws-connect-page-S1WwjRiU.js";import"./ui-vendor-BBvy5_e4.js";import"./index-JZK0iDKY.js";import"./charts-BvZVcBDs.js";import"./card-wt_nJGez.js";import"./label-D5xXvWxV.js";import"./select-CsywHznX.js";import"./index-eS30MLPM.js";import"./chevron-up-CIsz08Lk.js";import"./badge-DkYv5gj6.js";import"./notifications-CEhhHAa1.js";import"./circle-check-2r_On2bL.js";import"./trash-2-BHZN_fzT.js";import"./key-CgWt1gFH.js";import"./globe-C6pEHliD.js";import"./shield-check-psDAXoSw.js";import"./info-C41hep1V.js";class V{constructor({marshaller:t,serializer:i,deserializer:l,serdeContext:c,defaultContentType:m}){z(this,"marshaller");z(this,"serializer");z(this,"deserializer");z(this,"serdeContext");z(this,"defaultContentType");this.marshaller=t,this.serializer=i,this.deserializer=l,this.serdeContext=c,this.defaultContentType=m}async serializeEventStream({eventStream:t,requestSchema:i,initialRequest:l}){const c=this.marshaller,m=i.getEventStreamMember(),f=i.getMemberSchema(m),y=this.serializer,u=this.defaultContentType,h=Symbol("initialRequestMarker"),p={async*[Symbol.asyncIterator](){if(l){const s={":event-type":{type:"string",value:"initial-request"},":message-type":{type:"string",value:"event"},":content-type":{type:"string",value:u}};y.write(i,l);const d=y.flush();yield{[h]:!0,headers:s,body:d}}for await(const s of t)yield s}};return c.serialize(p,s=>{if(s[h])return{headers:s.headers,body:s.body};const d=Object.keys(s).find(n=>n!=="__type")??"",{additionalHeaders:r,body:e,eventType:a,explicitPayloadContentType:v}=this.writeEventBody(d,f,s);return{headers:{":event-type":{type:"string",value:a},":message-type":{type:"string",value:"event"},":content-type":{type:"string",value:v??u},...r},body:e}})}async deserializeEventStream({response:t,responseSchema:i,initialResponseContainer:l}){var d;const c=this.marshaller,m=i.getEventStreamMember(),y=i.getMemberSchema(m).getMemberSchemas(),u=Symbol("initialResponseMarker"),h=c.deserialize(t.body,async r=>{var v,x;const e=Object.keys(r).find(n=>n!=="__type")??"",a=r[e].body;if(e==="initial-response"){const n=await this.deserializer.read(i,a);return delete n[m],{[u]:!0,...n}}else if(e in y){const n=y[e];if(n.isStructSchema()){const o={};let M=!1;for(const[S,w]of n.structIterator()){const{eventHeader:T,eventPayload:C}=w.getMergedTraits();if(M=M||!!(T||C),C)w.isBlobSchema()?o[S]=a:w.isStringSchema()?o[S]=(((v=this.serdeContext)==null?void 0:v.utf8Encoder)??I)(a):w.isStructSchema()&&(o[S]=await this.deserializer.read(w,a));else if(T){const b=(x=r[e].headers[S])==null?void 0:x.value;b!=null&&(w.isNumericSchema()?b&&typeof b=="object"&&"bytes"in b?o[S]=BigInt(b.toString()):o[S]=Number(b):o[S]=b)}}if(M)return{[e]:o};if(a.byteLength===0)return{[e]:{}}}return{[e]:await this.deserializer.read(n,a)}}else return{$unknown:r}}),p=h[Symbol.asyncIterator](),s=await p.next();if(s.done)return h;if((d=s.value)!=null&&d[u]){if(!i)throw new Error("@smithy::core/protocols - initial-response event encountered in event stream but no response schema given.");for(const[r,e]of Object.entries(s.value))l[r]=e}return{async*[Symbol.asyncIterator](){var r;for((r=s==null?void 0:s.value)!=null&&r[u]||(yield s.value);;){const{done:e,value:a}=await p.next();if(e)break;yield a}}}}writeEventBody(t,i,l){var d;const c=this.serializer;let m=t,f=null,y;const u=i.getSchema()[4].includes(t),h={};if(u){const r=i.getMemberSchema(t);if(r.isStructSchema()){for(const[e,a]of r.structIterator()){const{eventHeader:v,eventPayload:x}=a.getMergedTraits();if(x)f=e;else if(v){const n=l[t][e];let o="binary";a.isNumericSchema()?(-2)**31<=n&&n<=2**31-1?o="integer":o="long":a.isTimestampSchema()?o="timestamp":a.isStringSchema()?o="string":a.isBooleanSchema()&&(o="boolean"),n!=null&&(h[e]={type:o,value:n},delete l[t][e])}}if(f!==null){const e=r.getMemberSchema(f);e.isBlobSchema()?y="application/octet-stream":e.isStringSchema()&&(y="text/plain"),c.write(e,l[t][f])}else c.write(r,l[t])}else throw new Error("@smithy/core/event-streams - non-struct member not supported in event stream union.")}else{const[r,e]=l[t];m=r,c.write(15,e)}const p=c.flush();return{body:typeof p=="string"?(((d=this.serdeContext)==null?void 0:d.utf8Decoder)??B)(p):p,eventType:m,explicitPayloadContentType:y,additionalHeaders:h}}}export{V as EventStreamSerde};
